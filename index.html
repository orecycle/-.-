<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบริหารจัดการคลินิกเวชกรรม</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for dropdowns to appear above other content */
        .relative {
            position: relative;
        }
        .absolute {
            position: absolute;
        }
        .z-10 {
            z-index: 10;
        }
    </style>
    <!-- Babel CDN for in-browser JSX transformation (for demonstration purposes) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Create a context for authentication and user data
        const AuthAndUsersContext = React.createContext(null);
        // Create a context for patient data and treatment records
        const PatientAndTreatmentContext = React.createContext(null);

        // Function to generate initial 100 basic drugs
        const generateInitialDrugs = () => {
            const baseDrugs = [
                { medicalName: 'Paracetamol', thaiName: 'พาราเซตามอล' },
                { medicalName: 'Ibuprofen', thaiName: 'ไอบูโพรเฟน' },
                { medicalName: 'Amoxicillin', thaiName: 'อะม็อกซีซิลลิน' },
                { medicalName: 'Omeprazole', thaiName: 'โอเมพราโซล' },
                { medicalName: 'Loratadine', thaiName: 'ลอราทาดีน' },
                { medicalName: 'Cetirizine', thaiName: 'เซทิริซีน' },
                { medicalName: 'Dextromethorphan', thaiName: 'เดกซ์โทรเมทอร์แฟน' },
                { medicalName: 'Guaifenesin', thaiName: 'กัวเฟนิซิน' },
                { medicalName: 'Salbutamol', thaiName: 'ซาลบูทามอล' },
                { medicalName: 'Amlodipine', thaiName: 'แอมโลดิพีน' },
                { medicalName: 'Metformin', thaiName: 'เมทฟอร์มิน' },
                { medicalName: 'Simvastatin', thaiName: 'ซิมวาสแตติน' },
                { medicalName: 'Aspirin', thaiName: 'แอสไพริน' },
                { medicalName: 'Metronidazole', thaiName: 'เมโทรนิดาโซล' },
                { medicalName: 'Ciprofloxacin', thaiName: 'ซิโปรฟลอกซาซิน' },
                { medicalName: 'Prednisolone', thaiName: 'เพรดนิโซโลน' },
                { medicalName: 'Ranitidine', thaiName: 'รานิทิดีน' },
                { medicalName: 'Domperidone', thaiName: 'ดอมเพอริโดน' },
                { medicalName: 'Bisacodyl', thaiName: 'ไบซาโคดิล' },
                { medicalName: 'Loperamide', thaiName: 'โลเพอราไมด์' },
                { medicalName: 'Oral Rehydration Salt', thaiName: 'ผงเกลือแร่' },
                { medicalName: 'Vitamin C', thaiName: 'วิตามินซี' },
                { medicalName: 'Multivitamin', thaiName: 'วิตามินรวม' },
                { medicalName: 'Folic Acid', thaiName: 'กรดโฟลิก' },
                { medicalName: 'Iron Supplement', thaiName: 'ธาตุเหล็ก' },
                { medicalName: 'Calcium Carbonate', thaiName: 'แคลเซียมคาร์บอเนต' },
                { medicalName: 'Magnesium Hydroxide', thaiName: 'แมกนีเซียมไฮดรอกไซด์' },
                { medicalName: 'Diphenhydramine', thaiName: 'ไดเฟนไฮดรามีน' },
                { medicalName: 'Hydrocortisone Cream', thaiName: 'ไฮโดรคอร์ติโซน ครีม' },
                { medicalName: 'Clotrimazole Cream', thaiName: 'โคลไตรมาโซล ครีม' },
                { medicalName: 'Betadine Solution', thaiName: 'เบตาดีน' },
                { medicalName: 'Alcohol Swab', thaiName: 'แอลกอฮอล์สวับ' },
                { medicalName: 'Band-Aid', thaiName: 'พลาสเตอร์ยา' },
                { medicalName: 'Gauze Pad', thaiName: 'ผ้าก๊อซ' },
                { medicalName: 'Antiseptic Solution', thaiName: 'น้ำยาฆ่าเชื้อ' },
                { medicalName: 'Cough Syrup (Herbal)', thaiName: 'ยาน้ำแก้ไอ (สมุนไพร)' },
                { medicalName: 'Activated Charcoal', thaiName: 'ถ่านกัมมันต์' },
                { medicalName: 'Epinephrine Auto-Injector', thaiName: 'ปากกาฉีดอะดรีนาลีน' },
                { medicalName: 'Insulin (various types)', thaiName: 'อินซูลิน (ชนิดต่างๆ)' },
                { medicalName: 'Warfarin', thaiName: 'วาร์ฟาริน' },
                { medicalName: 'Levothyroxine', thaiName: 'เลโวไทรอกซีน' },
                { medicalName: 'Sertraline', thaiName: 'เซอร์ทราลีน' },
                { medicalName: 'Diazepam', thaiName: 'ไดอะซีแพม' },
                { medicalName: 'Furosemide', thaiName: 'ฟูโรซีไมด์' },
                { medicalName: 'Hydrochlorothiazide', thaiName: 'ไฮโดรคลอโรไทอะไซด์' },
                { medicalName: 'Metoprolol', thaiName: 'เมโทโพรลอล' },
                { medicalName: 'Valsartan', thaiName: 'วาลซาร์แทน' },
                { medicalName: 'Atorvastatin', thaiName: 'อะทอร์วาสแตติน' },
                { medicalName: 'Rosuvastatin', thaiName: 'โรซูวาสแตติน' },
                { medicalName: 'Clopidogrel', thaiName: 'โคลพิโดเกรล' },
                { medicalName: 'Pantoprazole', thaiName: 'แพนโทพราโซล' },
                { medicalName: 'Esomeprazole', thaiName: 'เอสโซเมพราโซล' },
                { medicalName: 'Ranitidine', thaiName: 'รานิทิดีน' },
                { medicalName: 'Famotidine', thaiName: 'ฟาโมติดีน' },
                { medicalName: 'Ondansetron', thaiName: 'ออนดันซีทรอน' },
                { medicalName: 'Promethazine', thaiName: 'โพรเมทาซีน' },
                { medicalName: 'Cefalexin', thaiName: 'เซฟาเล็กซิน' },
                { medicalName: 'Azithromycin', thaiName: 'อะซิโธรมัยซิน' },
                { medicalName: 'Doxycycline', thaiName: 'ดอกซีไซคลิน' },
                { medicalName: 'Corticosteroid Nasal Spray', thaiName: 'สเปรย์พ่นจมูกสเตียรอยด์' },
                { medicalName: 'Eye Drops (Antibiotic)', thaiName: 'ยาหยอดตา (ปฏิชีวนะ)' },
                { medicalName: 'Ear Drops (Antibiotic)', thaiName: 'ยาหยอดหู (ปฏิชีวนะ)' },
                { medicalName: 'Topical Antifungal', thaiName: 'ยาต้านเชื้อราทา' },
                { medicalName: 'Topical Antibiotic', thaiName: 'ยาปฏิชีวนะทา' },
                { medicalName: 'Lidocaine Cream', thaiName: 'ยาชาลิโดเคน ครีม' },
                { medicalName: 'Antihistamine Cream', thaiName: 'ยาแก้แพ้ ครีม' },
                { medicalName: 'Oral Antifungal', thaiName: 'ยาต้านเชื้อรากิน' },
                { medicalName: 'Oral Antiviral', thaiName: 'ยาต้านไวรัสกิน' },
                { medicalName: 'Vaccine (Flu)', thaiName: 'วัคซีน (ไข้หวัดใหญ่)' },
                { medicalName: 'Vaccine (Tetanus)', thaiName: 'วัคซีน (บาดทะยัก)' },
                { medicalName: 'Contraceptive Pill', thaiName: 'ยาคุมกำเนิด' },
                { medicalName: 'Emergency Contraceptive', thaiName: 'ยาคุมฉุกเฉิน' },
                { medicalName: 'Thyroid Hormone', thaiName: 'ฮอร์โมนไทรอยด์' },
                { medicalName: 'Antidepressant', thaiName: 'ยาแก้ซึมเศร้า' },
                { medicalName: 'Antianxiety', thaiName: 'ยาคลายกังวล' },
                { medicalName: 'Sleeping Aid', thaiName: 'ยานอนหลับ' },
                { medicalName: 'Muscle Relaxant', thaiName: 'ยาคลายกล้ามเนื้อ' },
                { medicalName: 'Gout Medication', thaiName: 'ยาแก้โรคเกาต์' },
                { medicalName: 'Migraine Medication', thaiName: 'ยาแก้ไมเกรน' },
                { medicalName: 'Diabetic Foot Cream', thaiName: 'ครีมบำรุงเท้าผู้ป่วยเบาหวาน' },
                { medicalName: 'Wound Dressing', thaiName: 'วัสดุปิดแผล' },
                { medicalName: 'Suture Kit', thaiName: 'ชุดเย็บแผล' },
                { medicalName: 'Syringe (various sizes)', thaiName: 'ไซรินจ์ (ขนาดต่างๆ)' },
                { medicalName: 'Needle (various gauges)', thaiName: 'เข็ม (ขนาดต่างๆ)' },
                { medicalName: 'IV Solution (Normal Saline)', thaiName: 'น้ำเกลือ (Normal Saline)' },
                { medicalName: 'IV Solution (Dextrose)', thaiName: 'น้ำเกลือ (Dextrose)' },
                { medicalName: 'Urinary Catheter', thaiName: 'สายสวนปัสสาวะ' },
                { medicalName: 'Gloves (Sterile)', thaiName: 'ถุงมือปลอดเชื้อ' },
                { medicalName: 'Mask (Surgical)', thaiName: 'หน้ากากอนามัย (ศัลยกรรม)' },
                { medicalName: 'Hand Sanitizer', thaiName: 'เจลล้างมือ' },
                { medicalName: 'Thermometer', thaiName: 'ปรอทวัดไข้' },
                { medicalName: 'Blood Glucose Test Strips', thaiName: 'แถบตรวจน้ำตาลในเลือด' },
                { medicalName: 'Blood Pressure Cuff', thaiName: 'ผ้าพันแขนวัดความดัน' },
                { medicalName: 'Stethoscope', thaiName: 'หูฟังแพทย์' },
                { medicalName: 'Otoscope', thaiName: 'เครื่องส่องหู' },
                { medicalName: 'Ophthalmoscope', thaiName: 'เครื่องส่องตา' },
                { medicalName: 'Reflex Hammer', thaiName: 'ค้อนเคาะเข่า' },
                { medicalName: 'Tongue Depressor', thaiName: 'ไม้กดลิ้น' },
                { medicalName: 'Urine Test Strips', thaiName: 'แถบตรวจปัสสาวะ' },
                { medicalName: 'Nebulizer Solution', thaiName: 'น้ำยาพ่นยา' },
                { medicalName: 'Oxygen Mask', thaiName: 'หน้ากากออกซิเจน' },
                { medicalName: 'Splint (various sizes)', thaiName: 'เฝือก (ขนาดต่างๆ)' },
                { medicalName: 'Crutches', thaiName: 'ไม้ค้ำยัน' },
                { medicalName: 'Wheelchair', thaiName: 'รถเข็นผู้ป่วย' },
                { medicalName: 'First Aid Kit', thaiName: 'ชุดปฐมพยาบาล' },
                { medicalName: 'Burn Cream', thaiName: 'ครีมทาแผลไฟไหม้' },
                { medicalName: 'Insect Bite Cream', thaiName: 'ครีมทาแก้คัน' },
                { medicalName: 'Sunscreen', thaiName: 'ครีมกันแดด' },
                { medicalName: 'Mosquito Repellent', thaiName: 'ยากันยุง' },
                { medicalName: 'Throat Lozenge', thaiName: 'ยาอมแก้เจ็บคอ' },
                { medicalName: 'Nasal Decongestant', thaiName: 'ยาแก้คัดจมูก' },
                { medicalName: 'Antacid', thaiName: 'ยาลดกรด' },
                { medicalName: 'Laxative', thaiName: 'ยาถ่าย' },
                { medicalName: 'Anti-diarrhea', thaiName: 'ยาแก้ท้องเสีย' },
                { medicalName: 'Probiotic', thaiName: 'โปรไบโอติก' },
                { medicalName: 'Antiflatulent', thaiName: 'ยาขับลม' },
                { medicalName: 'Oral Thrush Treatment', thaiName: 'ยาแก้เชื้อราในช่องปาก' },
                { medicalName: 'Athlete\'s Foot Cream', thaiName: 'ครีมแก้โรคน้ำกัดเท้า' },
                { medicalName: 'Wart Remover', thaiName: 'ยาจี้หูด' },
                { medicalName: 'Cold Sore Cream', thaiName: 'ครีมทาเริม' },
                { medicalName: 'Eye Wash Solution', thaiName: 'น้ำยาล้างตา' },
                { medicalName: 'Contact Lens Solution', thaiName: 'น้ำยาแช่คอนแทคเลนส์' },
                { medicalName: 'Artificial Tears', thaiName: 'น้ำตาเทียม' },
                { medicalName: 'Ear Wax Remover', thaiName: 'ยาละลายขี้หู' },
                { medicalName: 'Hydrogen Peroxide', thaiName: 'ไฮโดรเจนเปอร์ออกไซด์' },
                { medicalName: 'Povidone-Iodine', thaiName: 'โพวิโดน-ไอโอดีน' },
                { medicalName: 'Chlorhexidine Solution', thaiName: 'คลอร์เฮกซิดีน โซลูชั่น' },
                { medicalName: 'Normal Saline Solution (for wound)', thaiName: 'น้ำเกลือล้างแผล' },
                { medicalName: 'Adhesive Tape', thaiName: 'เทปกาวทางการแพทย์' },
                { medicalName: 'Cotton Ball', thaiName: 'สำลี' },
                { medicalName: 'Alcohol Pad', thaiName: 'แผ่นแอลกอฮอล์' },
                { medicalName: 'Surgical Mask', thaiName: 'หน้ากากอนามัย' },
                { medicalName: 'Nitrile Gloves', thaiName: 'ถุงมือไนไตรล์' },
                { medicalName: 'Disposable Gown', thaiName: 'เสื้อคลุมใช้แล้วทิ้ง' },
            ];

            // Ensure at least 100 drugs by duplicating and slightly modifying if needed
            let drugs = [...baseDrugs];
            let counter = 0;
            while (drugs.length < 100) {
                const original = baseDrugs[counter % baseDrugs.length];
                drugs.push({
                    medicalName: `${original.medicalName} ${Math.floor(counter / baseDrugs.length) + 1}`,
                    thaiName: `${original.thaiName} ${Math.floor(counter / baseDrugs.length) + 1}`,
                });
                counter++;
            }
            return drugs.slice(0, 100).map((drug, index) => ({ ...drug, id: `drug-${index}` }));
        };

        // Function to generate initial dummy patient data
        const generateInitialPatients = () => {
            const patients = [
                { id: 'pat-001', idNumber: '1100100000001', title: 'นาย', firstNameThai: 'สมศักดิ์', lastNameThai: 'ใจดี', firstNameEng: 'Somsak', lastNameEng: 'Jaidee', gender: 'ชาย', dob: '1985-01-15', age: '39', nationality: 'ไทย', race: 'ไทย', religion: 'พุทธ', maritalStatus: 'สมรส', occupation: 'พนักงานบริษัท', estimatedIncome: '30000', education: 'ปริญญาตรี', address: '123 ถนนสุขุมวิท แขวงคลองเตย เขตคลองเตย กรุงเทพมหานคร 10110', homePhone: '021234567', mobilePhone: '0811234567', email: 'somsak.j@example.com', patientType: 'พนักงาน', medicalHistory: 'เคยผ่าตัดไส้ติ่งเมื่อ 5 ปีก่อน', preExistingConditions: 'ความดันโลหิตสูง', drugAllergies: 'แพ้ยาเพนิซิลลิน', regularMedications: 'ยาควบคุมความดัน', bloodType: 'A', familyMedicalHistory: 'บิดาเป็นเบาหวาน', vaccinationHistory: 'ครบตามวัย' },
                { id: 'pat-002', idNumber: '1100200000002', title: 'นางสาว', firstNameThai: 'อรุณี', lastNameThai: 'สุขสบาย', firstNameEng: 'Arunee', lastNameEng: 'Suksabai', gender: 'หญิง', dob: '1992-05-20', age: '32', nationality: 'ไทย', race: 'ไทย', religion: 'พุทธ', maritalStatus: 'โสด', occupation: 'ครู', estimatedIncome: '25000', education: 'ปริญญาโท', address: '456 ซอยลาดพร้าว 101 แขวงคลองจั่น เขตบางกะปิ กรุงเทพมหานคร 10240', homePhone: '029876543', mobilePhone: '0899876543', email: 'arunee.s@example.com', patientType: 'พนักงาน', medicalHistory: 'ไม่มี', preExistingConditions: 'ไม่มี', drugAllergies: 'ไม่มี', regularMedications: 'ไม่มี', bloodType: 'B', familyMedicalHistory: 'มารดาเป็นภูมิแพ้', vaccinationHistory: 'ครบตามวัย' },
                { id: 'pat-003', idNumber: '1100300000003', title: 'นาย', firstNameThai: 'ชูชาติ', lastNameThai: 'รุ่งเรือง', firstNameEng: 'Choochart', lastNameEng: 'Rungruang', gender: 'ชาย', dob: '1970-11-10', age: '54', nationality: 'ไทย', race: 'ไทย', religion: 'คริสต์', maritalStatus: 'สมรส', occupation: 'เกษตรกร', estimatedIncome: '15000', education: 'ประถมศึกษา', address: '789 หมู่ 5 ตำบลบางปลา อำเภอบางพลี จังหวัดสมุทรปราการ 10540', homePhone: '034567890', mobilePhone: '0877654321', email: 'choochart.r@example.com', patientType: 'พนักงาน', medicalHistory: 'เคยกระดูกหักที่ขาขวา', preExistingConditions: 'เบาหวาน', drugAllergies: 'ไม่มี', regularMedications: 'ยาเบาหวาน', bloodType: 'O', familyMedicalHistory: 'ไม่มีโรคประจำตัวในครอบครัว', vaccinationHistory: 'ไม่ครบ' },
                { id: 'pat-004', idNumber: '1100400000004', title: 'นาง', firstNameThai: 'สุดารัตน์', lastNameThai: 'งามยิ่ง', firstNameEng: 'Sudarat', lastNameEng: 'Namyim', gender: 'หญิง', dob: '1965-03-25', age: '59', nationality: 'ไทย', race: 'ไทย', religion: 'พุทธ', maritalStatus: 'หม้าย', occupation: 'ค้าขาย', estimatedIncome: '20000', education: 'มัธยมศึกษา', address: '101 ถนนเพชรเกษม แขวงหนองค้างพลู เขตหนองแขม กรุงเทพมหานคร 10160', homePhone: '023456789', mobilePhone: '0861234567', email: 'sudarat.n@example.com', patientType: 'พนักงาน', medicalHistory: 'เป็นภูมิแพ้มาตั้งแต่เด็ก', preExistingConditions: 'ภูมิแพ้', drugAllergies: 'แพ้อาหารทะเล', regularMedications: 'ยาแก้แพ้', bloodType: 'AB', familyMedicalHistory: 'ไม่มี', vaccinationHistory: 'ครบตามวัย' },
                { id: 'pat-005', idNumber: '1100500000005', title: 'เด็กชาย', firstNameThai: 'ปิติ', lastNameThai: 'รักชาติ', firstNameEng: 'Piti', lastNameEng: 'Rakchart', gender: 'ชาย', dob: '2018-08-01', age: '6', nationality: 'ไทย', race: 'ไทย', religion: 'พุทธ', maritalStatus: 'โสด', occupation: 'นักเรียน', estimatedIncome: '0', education: 'อนุบาล', address: '222 ซอยอารีย์สัมพันธ์ แขวงสามเสนใน เขตพญาไท กรุงเทพมหานคร 10400', homePhone: '025551111', mobilePhone: '0901112222', email: 'piti.r@example.com', patientType: 'พนักงาน', medicalHistory: 'เคยเป็นอีสุกอีใส', preExistingConditions: 'หอบหืดในวัยเด็ก', drugAllergies: 'ไม่มี', regularMedications: 'ยาพ่นหอบหืด', bloodType: 'A', familyMedicalHistory: 'บิดาเป็นหอบหืด', vaccinationHistory: 'ครบตามวัย' },
            ];
            return patients;
        };


        // AuthAndUsersProvider component to manage authentication and user data
        function AuthAndUsersProvider({ children }) {
            const [userRole, setUserRole] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [loadingAuth, setLoadingAuth] = React.useState(true);

            // Hardcoded users for demonstration without Firebase
            const [users, setUsers] = React.useState([
                { fullName: 'Admin User', username: 'admin', password: 'admin112', role: 'Admin', id: 'admin-id-123' },
                { fullName: 'นพ. สมชาย ใจดี', username: 'doctor', password: 'pass', role: 'แพทย์', id: 'doc-id-456' },
                { fullName: 'พญ. สุดาพร รักษาดี', username: 'doctor2', password: 'pass', role: 'แพทย์', id: 'doc-id-457' },
                { fullName: 'พยาบาล สมศรี มีสุข', username: 'nurse', password: 'pass', role: 'พยาบาล', id: 'nurse-id-789' },
                { fullName: 'ผู้ช่วย อารี แสงทอง', username: 'assistant', password: 'pass', role: 'ผู้ช่วยพยาบาล', id: 'asst-id-012' },
            ]);

            // Simulate initial authentication check
            React.useEffect(() => {
                const timer = setTimeout(() => {
                    setLoadingAuth(false);
                }, 500); // Simulate network delay

                return () => clearTimeout(timer);
            }, []);

            const value = { userId, userRole, loadingAuth, setUserRole, setUserId, users, setUsers };

            return (
                <AuthAndUsersContext.Provider value={value}>
                    {children}
                </AuthAndUsersContext.Provider>
            );
        }

        // PatientAndTreatmentProvider component to manage patient data and treatment records
        function PatientAndTreatmentProvider({ children }) {
            const [patients, setPatients] = React.useState(generateInitialPatients()); // Initialize with dummy patients
            const [treatmentRecords, setTreatmentRecords] = React.useState([]);
            const [drugs, setDrugs] = React.useState(generateInitialDrugs()); // Initialize with 100 drugs

            const addPatient = (newPatient) => {
                setPatients(prevPatients => [...prevPatients, { ...newPatient, id: Date.now().toString() }]);
            };

            const updatePatient = (updatedPatient) => {
                setPatients(prevPatients =>
                    prevPatients.map(p => (p.id === updatedPatient.id ? updatedPatient : p))
                );
            };

            const addTreatmentRecord = (newRecord) => {
                setTreatmentRecords(prevRecords => [...prevRecords, { ...newRecord, id: Date.now().toString() }]);
            };

            const updateTreatmentRecord = (updatedRecord) => {
                setTreatmentRecords(prevRecords =>
                    prevRecords.map(r => (r.id === updatedRecord.id ? updatedRecord : r))
                );
            };

            const addDrug = (newDrug) => {
                setDrugs(prevDrugs => [...prevDrugs, { ...newDrug, id: Date.now().toString() }]);
            };

            const value = { patients, addPatient, updatePatient, treatmentRecords, addTreatmentRecord, updateTreatmentRecord, drugs, addDrug };

            return (
                <PatientAndTreatmentContext.Provider value={value}>
                    {children}
                </PatientAndTreatmentContext.Provider>
            );
        }

        // Custom hook to use AuthAndUsersContext
        function useAuthAndUsers() {
            return React.useContext(AuthAndUsersContext);
        }

        // Custom hook to use PatientAndTreatmentContext
        function usePatientAndTreatment() {
            return React.useContext(PatientAndTreatmentContext);
        }

        // --- Utility Functions ---
        // Function to export data to CSV
        const exportToCsv = (filename, data) => {
            if (!data || data.length === 0) {
                alert('No data to export.');
                return;
            }

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(fieldName => JSON.stringify(row[fieldName] || '')).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // Function to export data to JSON
        const exportToJson = (filename, data) => {
            if (!data || data.length === 0) {
                alert('No data to export.');
                return;
            }

            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // Function to export detailed record to HTML
        const exportDetailedRecordToHtml = (filename, record) => {
            if (!record) {
                alert('No record to export.');
                return;
            }

            // Helper to render a section if data exists
            const renderSection = (title, content, isHtml = false) => {
                if (!content || (Array.isArray(content) && content.length === 0)) return '';
                if (typeof content === 'string' && content.trim() === '') return '';

                return `
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb;">${title}</h3>
                    ${isHtml ? content : `<p style="margin-bottom: 0.5rem;">${content}</p>`}
                `;
            };

            const medicationsHtml = record.medications.length > 0 ? `
                <h4 style="font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;">การจ่ายยา:</h4>
                ${record.medications.map(med => `
                    <div style="border-bottom: 1px dashed #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                        <p><strong>รายการยา:</strong> ${med.drugName}</p>
                        <p><strong>ปริมาณ:</strong> ${med.quantity} | <strong>ความถี่:</strong> ${med.frequency} | <strong>ระยะเวลา:</strong> ${med.duration}</p>
                        <p><strong>วิธีใช้:</strong> ${med.usageInstruction}</p>
                    </div>
                `).join('')}
            ` : '';

            const proceduresHtml = record.procedures.length > 0 ? `
                <h4 style="font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;">หัตถการ:</h4>
                ${record.procedures.map(proc => `
                    <div style="border-bottom: 1px dashed #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                        <p><strong>รายการหัตถการ:</strong> ${proc.procedureName}</p>
                        <p><strong>ค่าบริการ:</strong> ${proc.serviceFee}</p>
                    </div>
                `).join('')}
            ` : '';

            const labResultsHtml = record.labResults.length > 0 ? `
                <h3 style="font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb;">ผลตรวจทางห้องปฏิบัติการ</h3>
                ${record.labResults.map(lab => `
                    <div style="border-bottom: 1px dashed #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                        <p><strong>รายการตรวจ:</strong> ${lab.testName}</p>
                        <p><strong>วันที่ตรวจ:</strong> ${lab.testDate} | <strong>ห้องแล็บ:</strong> ${lab.labName}</p>
                        <p><strong>ผลลัพธ์:</strong> ${lab.result} | <strong>ค่าอ้างอิง:</strong> ${lab.referenceRange} | <strong>สถานะ:</strong> ${lab.status}</p>
                    </div>
                `).join('')}
            ` : '';


            const htmlContent = `
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>บันทึกการรักษาผู้ป่วย - ${record.patientName}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #333; margin: 20px; background-color: #f9fafb; }
                        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
                        h1 { font-size: 2.5rem; color: #1a202c; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #4299e1; padding-bottom: 10px; }
                        h2 { font-size: 1.75rem; color: #2d3748; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 1px solid #cbd5e0; padding-bottom: 0.5rem; }
                        h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
                        p { margin-bottom: 0.5rem; }
                        strong { color: #2d3748; }
                        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
                        .grid-item { padding: 0.5rem 0; }
                        .section-content { margin-bottom: 1.5rem; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>บันทึกการรักษาผู้ป่วย</h1>
                        <h2 style="text-align: center;">รายละเอียดการตรวจ</h2>

                        <div class="section-content">
                            <h3>1. ข้อมูลทั่วไปของการตรวจ</h3>
                            <div class="grid-container">
                                <p class="grid-item"><strong>ผู้ป่วย:</strong> ${record.patientName}</p>
                                <p class="grid-item"><strong>เลขผู้ป่วย:</strong> ${record.patientIdNumber}</p>
                                <p class="grid-item"><strong>แพทย์ผู้ตรวจ:</strong> ${record.examiningDoctorName}</p>
                                <p class="grid-item"><strong>วันที่/เวลาตรวจ:</strong> ${record.visitDate} ${record.visitTime}</p>
                                <p class="grid-item"><strong>สถานะ:</strong> ${record.visitStatus}</p>
                                <p class="grid-item"><strong>ประเภทการตรวจ:</strong> ${record.visitType}</p>
                            </div>
                        </div>

                        <div class="section-content">
                            <h3>2. อาการเบื้องต้น (Chief Complaint - CC)</h3>
                            <p><strong>รายละเอียดอาการ:</strong> ${record.chiefComplaint || '-'}</p>
                            <p><strong>ระยะเวลาอาการ:</strong> ${record.ccDuration || '-'}</p>
                            <p><strong>ปัจจัยกระตุ้น/บรรเทา:</strong> ${record.ccFactors || '-'}</p>
                        </div>

                        <div class="section-content">
                            <h3>3. ประวัติทางการแพทย์ที่เกี่ยวข้อง (History)</h3>
                            <p><strong>ประวัติการเจ็บป่วยครั้งก่อน:</strong> ${record.pastIllnessHistory || '-'}</p>
                            <p><strong>ประวัติแพ้ยา/อาหาร:</strong> ${record.allergyHistory || '-'}</p>
                            <p><strong>โรคประจำตัว:</strong> ${record.preExistingConditions || '-'}</p>
                            <p><strong>ประวัติการใช้ยา:</strong> ${record.medicationHistory || '-'}</p>
                            <p><strong>ประวัติครอบครัว:</strong> ${record.familyHistory || '-'}</p>
                            <p><strong>ประวัติการใช้สารเสพติด:</strong> ${record.substanceUseHistory || '-'}</p>
                        </div>

                        <div class="section-content">
                            <h3>4. ผลการตรวจร่างกาย (Physical Examination)</h3>
                            <div class="grid-container">
                                <p class="grid-item"><strong>อุณหภูมิ:</strong> ${record.vitalSigns.temperature || '-'}°C</p>
                                <p class="grid-item"><strong>ความดันโลหิต:</strong> ${record.vitalSigns.bloodPressure || '-'} mmHg</p>
                                <p class="grid-item"><strong>อัตราการเต้นของหัวใจ:</strong> ${record.vitalSigns.heartRate || '-'} bpm</p>
                                <p class="grid-item"><strong>อัตราการหายใจ:</strong> ${record.vitalSigns.respiratoryRate || '-'} breaths/min</p>
                                <p class="grid-item"><strong>ค่าออกซิเจนในเลือด:</strong> ${record.vitalSigns.oxygenSaturation || '-'}%</p>
                                <p class="grid-item"><strong>น้ำหนัก:</strong> ${record.vitalSigns.weight || '-'} kg</p>
                                <p class="grid-item"><strong>ส่วนสูง:</strong> ${record.vitalSigns.height || '-'} cm</p>
                                <p class="grid-item"><strong>BMI:</strong> ${record.vitalSigns.bmi || '-'}</p>
                            </div>
                            <p><strong>ตรวจร่างกายเฉพาะระบบ:</strong> ${record.systemicExam || '-'}</p>
                        </div>

                        ${labResultsHtml}

                        <div class="section-content">
                            <h3>5. การวินิจฉัยโรค (Diagnosis)</h3>
                            <p><strong>โรคที่วินิจฉัย:</strong> ${record.diagnosis || '-'}</p>
                            <p><strong>ลำดับโรค:</strong> ${record.diagnosisOrder || '-'}</p>
                            <p><strong>คำอธิบายเพิ่มเติม:</strong> ${record.diagnosisDescription || '-'}</p>
                        </div>

                        <div class="section-content">
                            <h3>6. แผนการรักษา (Plan / Treatment Plan)</h3>
                            <p><strong>ประเภทการรักษา:</strong> ${record.treatmentType.join(', ') || '-'}</p>
                            ${medicationsHtml}
                            ${proceduresHtml}
                            <p><strong>การให้คำแนะนำ:</strong> ${record.advice || '-'}</p>
                            <p><strong>ส่งต่อ:</strong> ${record.referral || '-'}</p>
                            <p><strong>ใบรับรองแพทย์/ใบลา/ใบส่งตัว:</strong> ${record.medicalCertificates || '-'}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };


        // --- Components ---

        // Message Box Component (instead of alert/confirm)
        function MessageBox({ message, onClose }) {
            if (!message) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <p className="text-lg font-semibold mb-4">{message}</p>
                        <button
                            onClick={onClose}
                            className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                        >
                            ตกลง
                        </button>
                    </div>
                </div>
            );
        }

        // Login Component
        function Login({ onLoginSuccess }) {
            const { setUserRole, setUserId, loadingAuth, userRole, users } = React.useContext(AuthAndUsersContext);
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [message, setMessage] = React.useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                const userFound = users.find(
                    user => user.username === username && user.password === password
                );

                if (userFound) {
                    setUserRole(userFound.role);
                    setUserId(userFound.id);
                    setMessage(`เข้าสู่ระบบสำเร็จในฐานะ: ${userFound.role}`);
                    onLoginSuccess(userFound.role);
                } else {
                    setMessage("ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง");
                }
            };

            const handleVisitorLogin = () => {
                setUserRole('ผู้เยี่ยมชม');
                setUserId('visitor-id-guest');
                setMessage("เข้าสู่ระบบในฐานะผู้เยี่ยมชม");
                onLoginSuccess('ผู้เยี่ยมชม');
            };

            if (loadingAuth) {
                return <div className="flex justify-center items-center h-screen text-xl">กำลังโหลดระบบ...</div>;
            }

            if (userRole) {
                return null;
            }

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-purple-200 p-4 font-inter">
                    <form onSubmit={handleLogin} className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-6">
                        <h2 className="text-3xl font-extrabold text-center text-gray-800 mb-6">เข้าสู่ระบบคลินิก</h2>
                        <div>
                            <label htmlFor="username" className="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้</label>
                            <input
                                type="text"
                                id="username"
                                className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                            <input
                                type="password"
                                id="password"
                                className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300"
                        >
                            เข้าสู่ระบบ
                        </button>
                        <button
                            type="button"
                            onClick={handleVisitorLogin}
                            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300"
                        >
                            เข้าสู่ระบบในฐานะผู้เยี่ยมชม
                        </button>
                    </form>
                    <MessageBox message={message} onClose={() => setMessage('')} />
                </div>
            );
        }

        // Dashboard Component
        function Dashboard() {
            const { userRole, userId } = React.useContext(AuthAndUsersContext);
            const [message, setMessage] = React.useState('');

            const summarizeData = (timeframe) => {
                let summary = '';
                switch (timeframe) {
                    case 'day':
                        summary = 'สรุปข้อมูลประจำวัน: ผู้ป่วยใหม่ 5 ราย, นัดหมาย 10 ครั้ง, รายได้ 5,000 บาท (ข้อมูลจำลอง)';
                        break;
                    case 'week':
                        summary = 'สรุปข้อมูลประจำสัปดาห์: ผู้ป่วยใหม่ 30 ราย, นัดหมาย 60 ครั้ง, รายได้ 30,000 บาท (ข้อมูลจำลอง)';
                        break;
                    case 'month':
                        summary = 'สรุปข้อมูลประจำเดือน: ผู้ป่วยใหม่ 120 ราย, นัดหมาย 250 ครั้ง, รายได้ 120,000 บาท (ข้อมูลจำลอง)';
                        break;
                    case 'year':
                        summary = 'สรุปข้อมูลประจำปี: ผู้ป่วยใหม่ 1,500 ราย, นัดหมาย 3,000 ครั้ง, รายได้ 1,500,000 บาท (ข้อมูลจำลอง)';
                        break;
                    default:
                        summary = 'กรุณาเลือกช่วงเวลาเพื่อสรุปข้อมูล';
                }
                setMessage(summary);
            };

            return (
                <div className="p-8 bg-gray-50 min-h-screen font-inter">
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-6">แดชบอร์ด</h1>
                    <p className="text-lg text-gray-700 mb-4">ยินดีต้อนรับ, <span className="font-semibold text-blue-600">{userRole}</span> (ID: {userId})</p>

                    {userRole !== 'ผู้เยี่ยมชม' && (
                        <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">สรุปข้อมูลรวม</h2>
                            <div className="flex flex-wrap gap-4 mb-4">
                                <button onClick={() => summarizeData('day')} className="px-5 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-md transition duration-300">วัน</button>
                                <button onClick={() => summarizeData('week')} className="px-5 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg shadow-md transition duration-300">สัปดาห์</button>
                                <button onClick={() => summarizeData('month')} className="px-5 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md transition duration-300">เดือน</button>
                                <button onClick={() => summarizeData('year')} className="px-5 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg shadow-md transition duration-300">ปี</button>
                            </div>
                            <p className="text-gray-700 text-lg">{message || "เลือกช่วงเวลาเพื่อดูสรุปข้อมูล"}</p>
                        </div>
                    )}

                    {userRole === 'ผู้เยี่ยมชม' && (
                        <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">ข้อมูลสำหรับผู้เยี่ยมชม</h2>
                            <p className="text-gray-700 text-lg">คุณมีสิทธิ์เข้าถึงข้อมูลบางส่วนเท่านั้น เช่น ข้อมูลทั่วไปของคลินิกและบริการ</p>
                            <p className="text-gray-600 mt-2">ตัวอย่าง: เวลาทำการ, ที่ตั้ง, รายชื่อแพทย์ (ข้อมูลสาธารณะ)</p>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <h3 className="text-xl font-bold text-gray-800 mb-2">นัดหมายวันนี้</h3>
                            <p className="text-gray-700">ไม่มีนัดหมายที่กำลังจะมาถึง</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <h3 className="text-xl font-bold text-gray-800 mb-2">ผู้ป่วยใหม่วันนี้</h3>
                            <p className="text-700">ยังไม่มีผู้ป่วยใหม่</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <h3 className="text-xl font-bold text-gray-800 mb-2">ประกาศจากคลินิก</h3>
                            <p className="text-gray-700">ไม่มีประกาศใหม่</p>
                        </div>
                    </div>
                </div>
            );
        }

        // Admin Panel for User Management
        function AdminPanel() {
            const { userRole, users, setUsers } = React.useContext(AuthAndUsersContext);
            const [form, setForm] = React.useState({ id: null, fullName: '', username: '', password: '', role: 'แพทย์' });
            const [message, setMessage] = React.useState('');
            const [showConfirm, setShowConfirm] = React.useState(false);
            const [userToDelete, setUserToDelete] = React.useState(null);

            const roles = ['Admin', 'แพทย์', 'พยาบาล', 'ผู้ช่วยพยาบาล', 'ผู้เยี่ยมชม'];

            const handleChange = (e) => {
                setForm({ ...form, [e.target.name]: e.target.value });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                try {
                    if (form.id) {
                        setUsers(users.map(u => u.id === form.id ? { ...form } : u));
                        setMessage("แก้ไขผู้ใช้สำเร็จ!");
                    } else {
                        const newUser = { ...form, id: Date.now().toString() };
                        setUsers([...users, newUser]);
                        setMessage("เพิ่มผู้ใช้สำเร็จ!");
                    }
                    setForm({ id: null, fullName: '', username: '', password: '', role: 'แพทย์' });
                } catch (err) {
                    console.error("Error adding/updating user:", err);
                    setMessage("เกิดข้อผิดพลาด: " + err.message);
                }
            };

            const handleEdit = (user) => {
                setForm({ id: user.id, fullName: user.fullName, username: user.username, password: user.password, role: user.role });
            };

            const handleDeleteClick = (user) => {
                setUserToDelete(user);
                setShowConfirm(true);
            };

            const confirmDelete = () => {
                if (!userToDelete) {
                    setMessage("ไม่มีผู้ใช้ให้ลบ");
                    setShowConfirm(false);
                    return;
                }
                try {
                    setUsers(users.filter(u => u.id !== userToDelete.id));
                    setMessage("ลบผู้ใช้สำเร็จ!");
                    setUserToDelete(null);
                    setShowConfirm(false);
                } catch (err) {
                    console.error("Error deleting user:", err);
                    setMessage("เกิดข้อผิดพลาดในการลบผู้ใช้: " + err.message);
                    setShowConfirm(false);
                }
            };

            const cancelDelete = () => {
                setUserToDelete(null);
                setShowConfirm(false);
            };

            if (userRole !== 'Admin') {
                return <div className="p-8 text-red-600 font-bold text-xl">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>;
            }

            return (
                <div className="p-8 bg-gray-50 min-h-screen font-inter">
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-6">จัดการบัญชีผู้ใช้</h1>

                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">{form.id ? 'แก้ไขผู้ใช้' : 'เพิ่มผู้ใช้ใหม่'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ชื่อ-สกุลจริง</label>
                                <input type="text" name="fullName" value={form.fullName} onChange={handleChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ชื่อใช้ในการเข้าใช้</label>
                                <input type="text" name="username" value={form.username} onChange={handleChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                                <input type="password" name="password" value={form.password} onChange={handleChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ระดับสิทธิ์</label>
                                <select name="role" value={form.role} onChange={handleChange} required
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Admin">Admin</option>
                                    <option value="แพทย์">แพทย์</option>
                                    <option value="พยาบาล">พยาบาล</option>
                                    <option value="ผู้ช่วยพยาบาล">ผู้ช่วยพยาบาล</option>
                                    <option value="ผู้เยี่ยมชม">ผู้เยี่ยมชม</option>
                                </select>
                            </div>
                            <button type="submit"
                                    className="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                                {form.id ? 'บันทึกการแก้ไข' : 'เพิ่มผู้ใช้'}
                            </button>
                        </form>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">รายชื่อผู้ใช้</h2>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-สกุลจริง</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อผู้ใช้</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ระดับสิทธิ์</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {users.map((user) => (
                                        <tr key={user.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{user.fullName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{user.username}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{user.role}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onClick={() => handleEdit(user)} className="text-indigo-600 hover:text-indigo-900 mr-4">แก้ไข</button>
                                                <button onClick={() => handleDeleteClick(user)} className="text-red-600 hover:text-red-900">ลบ</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <MessageBox message={message} onClose={() => setMessage('')} />
                    {showConfirm && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                                <p className="text-lg font-semibold mb-4">คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ {userToDelete?.username}?</p>
                                <div className="flex justify-center gap-4">
                                    <button
                                        onClick={confirmDelete}
                                        className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                                    >
                                        ยืนยัน
                                    </button>
                                    <button
                                        onClick={cancelDelete}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300"
                                    >
                                        ยกเลิก
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Patient Registration Component
        function PatientRegistration() {
            const { userRole } = React.useContext(AuthAndUsersContext);
            const { addPatient } = React.useContext(PatientAndTreatmentContext);
            const [formData, setFormData] = React.useState({
                idNumber: '', title: 'นาย', firstNameThai: '', lastNameThai: '', firstNameEng: '', lastNameEng: '',
                gender: 'ชาย', dob: '', age: '', nationality: '', race: '', religion: '', maritalStatus: 'โสด',
                occupation: '', estimatedIncome: '', education: '', address: '', homePhone: '', mobilePhone: '',
                email: '', patientType: 'พนักงาน', medicalHistory: '', preExistingConditions: '', drugAllergies: '',
                regularMedications: '', bloodType: '', familyMedicalHistory: '', vaccinationHistory: ''
            });
            const [message, setMessage] = React.useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleDateChange = (e) => {
                const dob = e.target.value;
                setFormData(prev => ({ ...prev, dob }));
                if (dob) {
                    const birthDate = new Date(dob);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    setFormData(prev => ({ ...prev, age: age.toString() }));
                } else {
                        setFormData(prev => ({ ...prev, age: '' }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                addPatient(formData);
                setMessage("ลงทะเบียนผู้ป่วยใหม่สำเร็จ! (ข้อมูลถูกบันทึกในหน่วยความจำชั่วคราว)");
                setFormData({
                    idNumber: '', title: 'นาย', firstNameThai: '', lastNameThai: '', firstNameEng: '', lastNameEng: '',
                    gender: 'ชาย', dob: '', age: '', nationality: '', race: '', religion: '', maritalStatus: 'โสด',
                    occupation: '', estimatedIncome: '', education: '', address: '', homePhone: '', mobilePhone: '',
                    email: '', patientType: 'พนักงาน', medicalHistory: '', preExistingConditions: '', drugAllergies: '',
                    regularMedications: '', bloodType: '', familyMedicalHistory: '', vaccinationHistory: ''
                });
            };

            if (userRole === 'ผู้เยี่ยมชม') {
                return <div className="p-8 text-red-600 font-bold text-xl">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>;
            }

            return (
                <div className="p-8 bg-gray-50 min-h-screen font-inter">
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-6">ลงทะเบียนผู้ป่วยใหม่</h1>

                    <form onSubmit={handleSubmit} className="bg-white p-8 rounded-2xl shadow-2xl space-y-6">
                        {/* Personal Information */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">1. ข้อมูลส่วนบุคคล</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">เลขประจำตัวประชาชน / หนังสือเดินทาง</label>
                                <input type="text" name="idNumber" value={formData.idNumber} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">คำนำหน้า</label>
                                <select name="title" value={formData.title} onChange={handleChange}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="นาย">นาย</option>
                                    <option value="นางสาว">นางสาว</option>
                                    <option value="นาง">นาง</option>
                                    <option value="เด็กชาย">เด็กชาย</option>
                                    <option value="เด็กหญิง">เด็กหญิง</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ชื่อ (ไทย)</label>
                                <input type="text" name="firstNameThai" value={formData.firstNameThai} onChange={handleChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">นามสกุล (ไทย)</label>
                                <input type="text" name="lastNameThai" value={formData.lastNameThai} onChange={handleChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ชื่อ (อังกฤษ)</label>
                                <input type="text" name="firstNameEng" value={formData.firstNameEng} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">นามสกุล (อังกฤษ)</label>
                                <input type="text" name="lastNameEng" value={formData.lastNameEng} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">เพศ</label>
                                <select name="gender" value={formData.gender} onChange={handleChange}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="ชาย">ชาย</option>
                                    <option value="หญิง">หญิง</option>
                                    <option value="ไม่ระบุ">ไม่ระบุ</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">วันเดือนปีเกิด</label>
                                <input type="date" name="dob" value={formData.dob} onChange={handleDateChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">อายุ</label>
                                <input type="text" name="age" value={formData.age} readOnly disabled
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">สัญชาติ</label>
                                <input type="text" name="nationality" value={formData.nationality} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">เชื้อชาติ</label>
                                <input type="text" name="race" value={formData.race} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ศาสนา</label>
                                <input type="text" name="religion" value={formData.religion} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">สถานภาพสมรส</label>
                                <select name="maritalStatus" value={formData.maritalStatus} onChange={handleChange}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="โสด">โสด</option>
                                    <option value="สมรส">สมรส</option>
                                    <option value="หย่าร้าง">หย่าร้าง</option>
                                    <option value="หม้าย">หม้าย</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">อาชีพ / ตำแหน่ง</label>
                                <input type="text" name="occupation" value={formData.occupation} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">รายได้โดยประมาณ</label>
                                <input type="text" name="estimatedIncome" value={formData.estimatedIncome} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">การศึกษา</label>
                                <input type="text" name="education" value={formData.education} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div className="md:col-span-2 lg:col-span-3">
                                <label className="block text-sm font-medium text-gray-700">ที่อยู่ปัจจุบัน</label>
                                <textarea name="address" value={formData.address} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ (บ้าน)</label>
                                <input type="text" name="homePhone" value={formData.homePhone} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ (มือถือ)</label>
                                <input type="text" name="mobilePhone" value={formData.mobilePhone} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">อีเมล</label>
                                <input type="email" name="email" value={formData.email} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ประเภทผู้ป่วย</label>
                                <select name="patientType" value={formData.patientType} onChange={handleChange}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="พนักงาน">พนักงาน</option>
                                    <option value="นักท่องเที่ยว">นักท่องเที่ยว</option>
                                </select>
                            </div>
                        </div>

                        {/* Health & Medical Information */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">2. ประวัติสุขภาพ & ข้อมูลทางการแพทย์</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">ประวัติการรักษา</label>
                                <textarea name="medicalHistory" value={formData.medicalHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">โรคประจำตัว</label>
                                <textarea name="preExistingConditions" value={formData.preExistingConditions} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">อาการแพ้ยา</label>
                                <textarea name="drugAllergies" value={formData.drugAllergies} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">ยาที่ใช้เป็นประจำ</label>
                                <textarea name="regularMedications" value={formData.regularMedications} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">กรุ๊ปเลือด</label>
                                <select name="bloodType" value={formData.bloodType} onChange={handleChange}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">เลือกกรุ๊ปเลือด</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="AB">AB</option>
                                    <option value="O">O</option>
                                </select>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">ประวัติโรคในครอบครัว</label>
                                <textarea name="familyMedicalHistory" value={formData.familyMedicalHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">ประวัติการฉีดวัคซีน</label>
                                <textarea name="vaccinationHistory" value={formData.vaccinationHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>

                        <button type="submit"
                                className="w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                            บันทึกข้อมูลผู้ป่วย
                        </button>
                    </form>
                    <MessageBox message={message} onClose={() => setMessage('')} />
                </div>
            );
        }

        // Edit Patient Modal Component
        function EditPatientModal({ patient, onClose, onSave }) {
            const { userRole } = React.useContext(AuthAndUsersContext);
            const [formData, setFormData] = React.useState(patient);
            const [message, setMessage] = React.useState('');

            React.useEffect(() => {
                setFormData(patient);
            }, [patient]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleDateChange = (e) => {
                const dob = e.target.value;
                setFormData(prev => ({ ...prev, dob }));
                if (dob) {
                    const birthDate = new Date(dob);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    setFormData(prev => ({ ...prev, age: age.toString() }));
                } else {
                    setFormData(prev => ({ ...prev, age: '' }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
                setMessage("บันทึกการแก้ไขข้อมูลผู้ป่วยสำเร็จ!");
                onClose(); // Close modal after saving
            };

            if (userRole === 'ผู้เยี่ยมชม') {
                return <div className="p-8 text-red-600 font-bold text-xl">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>;
            }

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl overflow-y-auto max-h-[90vh]">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">แก้ไขข้อมูลผู้ป่วย: {patient.firstNameThai} {patient.lastNameThai}</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* Personal Information */}
                            <h3 className="text-xl font-bold text-gray-800">1. ข้อมูลส่วนบุคคล</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">เลขประจำตัวประชาชน / หนังสือเดินทาง</label>
                                    <input type="text" name="idNumber" value={formData.idNumber} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">คำนำหน้า</label>
                                    <select name="title" value={formData.title} onChange={handleChange}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="นาย">นาย</option>
                                        <option value="นางสาว">นางสาว</option>
                                        <option value="นาง">นาง</option>
                                        <option value="เด็กชาย">เด็กชาย</option>
                                        <option value="เด็กหญิง">เด็กหญิง</option>
                                        <option value="อื่นๆ">อื่นๆ</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ชื่อ (ไทย)</label>
                                    <input type="text" name="firstNameThai" value={formData.firstNameThai} onChange={handleChange} required
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">นามสกุล (ไทย)</label>
                                    <input type="text" name="lastNameThai" value={formData.lastNameThai} onChange={handleChange} required
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ชื่อ (อังกฤษ)</label>
                                    <input type="text" name="firstNameEng" value={formData.firstNameEng} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">นามสกุล (อังกฤษ)</label>
                                    <input type="text" name="lastNameEng" value={formData.lastNameEng} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">เพศ</label>
                                    <select name="gender" value={formData.gender} onChange={handleChange}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="ชาย">ชาย</option>
                                        <option value="หญิง">หญิง</option>
                                        <option value="ไม่ระบุ">ไม่ระบุ</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">วันเดือนปีเกิด</label>
                                    <input type="date" name="dob" value={formData.dob} onChange={handleDateChange} required
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">อายุ</label>
                                    <input type="text" name="age" value={formData.age} readOnly disabled
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">สัญชาติ</label>
                                    <input type="text" name="nationality" value={formData.nationality} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">เชื้อชาติ</label>
                                    <input type="text" name="race" value={formData.race} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ศาสนา</label>
                                    <input type="text" name="religion" value={formData.religion} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">สถานภาพสมรส</label>
                                    <select name="maritalStatus" value={formData.maritalStatus} onChange={handleChange}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="โสด">โสด</option>
                                        <option value="สมรส">สมรส</option>
                                        <option value="หย่าร้าง">หย่าร้าง</option>
                                        <option value="หม้าย">หม้าย</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">อาชีพ / ตำแหน่ง</label>
                                    <input type="text" name="occupation" value={formData.occupation} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">รายได้โดยประมาณ</label>
                                    <input type="text" name="estimatedIncome" value={formData.estimatedIncome} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">การศึกษา</label>
                                    <input type="text" name="education" value={formData.education} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700">ที่อยู่ปัจจุบัน</label>
                                    <textarea name="address" value={formData.address} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ (บ้าน)</label>
                                    <input type="text" name="homePhone" value={formData.homePhone} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ (มือถือ)</label>
                                    <input type="text" name="mobilePhone" value={formData.mobilePhone} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">อีเมล</label>
                                    <input type="email" name="email" value={formData.email} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ประเภทผู้ป่วย</label>
                                    <select name="patientType" value={formData.patientType} onChange={handleChange}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="พนักงาน">พนักงาน</option>
                                        <option value="นักท่องเที่ยว">นักท่องเที่ยว</option>
                                    </select>
                                </div>
                            </div>

                            {/* Health & Medical Information */}
                            <h3 className="text-xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">2. ประวัติสุขภาพ & ข้อมูลทางการแพทย์</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">ประวัติการรักษา</label>
                                    <textarea name="medicalHistory" value={formData.medicalHistory} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">โรคประจำตัว</label>
                                    <textarea name="preExistingConditions" value={formData.preExistingConditions} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">อาการแพ้ยา</label>
                                    <textarea name="drugAllergies" value={formData.drugAllergies} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">ยาที่ใช้เป็นประจำ</label>
                                    <textarea name="regularMedications" value={formData.regularMedications} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">กรุ๊ปเลือด</label>
                                    <select name="bloodType" value={formData.bloodType} onChange={handleChange}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">เลือกกรุ๊ปเลือด</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="AB">AB</option>
                                        <option value="O">O</option>
                                    </select>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">ประวัติโรคในครอบครัว</label>
                                    <textarea name="familyMedicalHistory" value={formData.familyMedicalHistory} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">ประวัติการฉีดวัคซีน</label>
                                    <textarea name="vaccinationHistory" value={formData.vaccinationHistory} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>

                            <div className="flex justify-end gap-4 mt-6">
                                <button type="button" onClick={onClose}
                                        className="py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-lg font-semibold text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                                    ยกเลิก
                                </button>
                                <button type="submit"
                                        className="py-2 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                    บันทึกการแก้ไข
                                </button>
                            </div>
                        </form>
                        <MessageBox message={message} onClose={() => setMessage('')} />
                    </div>
                </div>
            );
        }


        // Patient Search And Records Component (Combined)
        function PatientSearchAndRecords({ onEditTreatmentRecord }) {
            const { userRole, users } = React.useContext(AuthAndUsersContext);
            const { patients, treatmentRecords, updatePatient } = React.useContext(PatientAndTreatmentContext);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [searchResults, setSearchResults] = React.useState([]);
            const [selectedPatient, setSelectedPatient] = React.useState(null);
            const [filteredTreatmentRecords, setFilteredTreatmentRecords] = React.useState([]);
            const [selectedRecordDetails, setSelectedRecordDetails] = React.useState(null);
            const [showEditPatientModal, setShowEditPatientModal] = React.useState(false);

            React.useEffect(() => {
                handleSearch();
            }, [patients, searchTerm]); // Re-run patient search if patients or search term changes

            React.useEffect(() => {
                if (selectedPatient) {
                    // Filter treatment records for the selected patient
                    const recordsForPatient = treatmentRecords.filter(record => record.patientId === selectedPatient.id);
                    setFilteredTreatmentRecords(recordsForPatient);
                } else {
                    setFilteredTreatmentRecords([]);
                }
            }, [selectedPatient, treatmentRecords]); // Re-run record filter if selected patient or records change

            const handleSearch = () => {
                if (!searchTerm) {
                    setSearchResults(patients); // Show all patients if no search term
                    setSelectedPatient(null); // Clear selected patient when search term is empty
                    return;
                }
                const filtered = patients.filter(patient =>
                    patient.idNumber.includes(searchTerm) ||
                    patient.firstNameThai.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    patient.lastNameThai.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    patient.firstNameEng.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    patient.lastNameEng.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    patient.mobilePhone.includes(searchTerm)
                );
                setSearchResults(filtered);
                setSelectedPatient(null); // Clear selected patient on new search
            };

            const handleSelectPatientForRecords = (patient) => {
                setSelectedPatient(patient);
            };

            const handleViewRecordDetails = (record) => {
                setSelectedRecordDetails(record);
            };

            const handleCloseRecordDetails = () => {
                setSelectedRecordDetails(null);
            };

            const handleEditPatientClick = (patient) => {
                setSelectedPatient(patient); // Ensure the correct patient is selected for editing
                setShowEditPatientModal(true);
            };

            const handleSaveEditedPatient = (updatedPatientData) => {
                updatePatient(updatedPatientData);
                setShowEditPatientModal(false);
                // Re-select patient to refresh displayed details if any
                setSelectedPatient(updatedPatientData);
            };

            const handleCloseEditPatientModal = () => {
                setShowEditPatientModal(false);
            };

            const handleExportPatientsCSV = () => {
                exportToCsv('patient_data.csv', searchResults);
            };

            const handleExportPatientsJSON = () => {
                exportToJson('patient_data.json', searchResults);
            };

            const handleExportRecordsCSV = () => {
                if (selectedPatient) {
                    exportToCsv(`treatment_records_${selectedPatient.id}.csv`, filteredTreatmentRecords);
                } else {
                    alert('Please select a patient to export their treatment records.');
                }
            };

            const handleExportRecordsJSON = () => {
                if (selectedPatient) {
                    exportToJson(`treatment_records_${selectedPatient.id}.json`, filteredTreatmentRecords);
                } else {
                    alert('Please select a patient to export their treatment records.');
                }
            };

            const handleExportDetailedRecord = () => {
                if (selectedRecordDetails) {
                    exportDetailedRecordToHtml(`treatment_record_details_${selectedRecordDetails.patientId}_${selectedRecordDetails.id}.html`, selectedRecordDetails);
                } else {
                    alert('Please view a record\'s details first to export it.');
                }
            };


            if (userRole === 'ผู้เยี่ยมชม') {
                return <div className="p-8 text-red-600 font-bold text-xl">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>;
            }

            return (
                <div className="p-8 bg-gray-50 min-h-screen font-inter">
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-6">ค้นหาผู้ป่วยและบันทึกการรักษา</h1>

                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <div className="flex flex-col md:flex-row gap-4 mb-4">
                            <input
                                type="text"
                                placeholder="ค้นหาด้วยเลขประจำตัว, ชื่อ, นามสกุล, เบอร์โทรศัพท์"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                            />
                            <button
                                onClick={handleSearch}
                                className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition duration-300"
                            >
                                ค้นหา
                            </button>
                        </div>

                        <h2 className="text-2xl font-bold text-gray-800 mb-4 mt-6">ผลการค้นหาผู้ป่วย</h2>
                        <div className="flex gap-2 mb-4">
                            <button onClick={handleExportPatientsCSV} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg shadow-md">ส่งออกผู้ป่วย (CSV)</button>
                            <button onClick={handleExportPatientsJSON} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg shadow-md">ส่งออกผู้ป่วย (JSON)</button>
                        </div>
                        {searchResults.length === 0 ? (
                            <p className="text-gray-600">ไม่พบข้อมูลผู้ป่วย</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขประจำตัว</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล (ไทย)</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันเกิด</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เบอร์โทรศัพท์</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {searchResults.map((patient) => (
                                            <tr key={patient.id} className={selectedPatient?.id === patient.id ? 'bg-blue-50' : ''}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{patient.idNumber}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{patient.title} {patient.firstNameThai} {patient.lastNameThai}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{patient.dob}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{patient.mobilePhone}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onClick={() => handleSelectPatientForRecords(patient)} className="text-indigo-600 hover:text-indigo-900 mr-4">ดูบันทึกการรักษา</button>
                                                    <button onClick={() => handleEditPatientClick(patient)} className="text-green-600 hover:text-green-900">แก้ไขข้อมูล</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    {selectedPatient && (
                        <div className="bg-white p-6 rounded-xl shadow-lg mt-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">บันทึกการรักษาของ: {selectedPatient.title} {selectedPatient.firstNameThai} {selectedPatient.lastNameThai}</h2>
                            <div className="flex gap-2 mb-4">
                                <button onClick={handleExportRecordsCSV} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg shadow-md">ส่งออกบันทึก (CSV)</button>
                                <button onClick={handleExportRecordsJSON} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg shadow-md">ส่งออกบันทึก (JSON)</button>
                            </div>
                            {filteredTreatmentRecords.length === 0 ? (
                                <p className="text-gray-600">ยังไม่มีบันทึกการรักษาสำหรับผู้ป่วยรายนี้</p>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่ตรวจ</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แพทย์ผู้ตรวจ</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภทการตรวจ</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">อาการเบื้องต้น</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {filteredTreatmentRecords.map((record) => (
                                                <tr key={record.id}>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{record.visitDate} {record.visitTime}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{record.examiningDoctorName}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{record.visitType}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{record.chiefComplaint.substring(0, 50)}...</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <button onClick={() => handleViewRecordDetails(record)} className="text-indigo-600 hover:text-indigo-900 mr-4">ดูรายละเอียด</button>
                                                        <button onClick={() => onEditTreatmentRecord(record.id)} className="text-green-600 hover:text-green-900">แก้ไข</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}

                    {selectedRecordDetails && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl overflow-y-auto max-h-[90vh]">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">รายละเอียดบันทึกการรักษา</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                                    <p><strong>ผู้ป่วย:</strong> {selectedRecordDetails.patientName}</p>
                                    <p><strong>เลขผู้ป่วย:</strong> {selectedRecordDetails.patientIdNumber}</p>
                                    <p><strong>แพทย์ผู้ตรวจ:</strong> {selectedRecordDetails.examiningDoctorName}</p>
                                    <p><strong>วันที่/เวลาตรวจ:</strong> ${selectedRecordDetails.visitDate} ${selectedRecordDetails.visitTime}</p>
                                    <p><strong>สถานะ:</strong> ${selectedRecordDetails.visitStatus}</p>
                                    <p><strong>ประเภทการตรวจ:</strong> ${selectedRecordDetails.visitType}</p>
                                    <p className="md:col-span-2"><strong>อาการเบื้องต้น:</strong> ${selectedRecordDetails.chiefComplaint}</p>
                                    <p><strong>ระยะเวลาอาการ:</strong> ${selectedRecordDetails.ccDuration}</p>
                                    <p><strong>ปัจจัยกระตุ้น/บรรเทา:</strong> ${selectedRecordDetails.ccFactors}</p>
                                    <p className="md:col-span-2"><strong>ประวัติการเจ็บป่วยครั้งก่อน:</strong> ${selectedRecordDetails.pastIllnessHistory}</p>
                                    <p className="md:col-span-2"><strong>ประวัติแพ้ยา/อาหาร:</strong> ${selectedRecordDetails.allergyHistory}</p>
                                    <p className="md:col-span-2"><strong>โรคประจำตัว:</strong> ${selectedRecordDetails.preExistingConditions}</p>
                                    <p className="md:col-span-2"><strong>ประวัติการใช้ยา:</strong> ${selectedRecordDetails.medicationHistory}</p>
                                    <p className="md:col-span-2"><strong>ประวัติครอบครัว:</strong> ${selectedRecordDetails.familyHistory}</p>
                                    <p className="md:col-span-2"><strong>ประวัติการใช้สารเสพติด:</strong> ${selectedRecordDetails.substanceUseHistory}</p>

                                    <h3 className="md:col-span-2 text-xl font-bold mt-4">ผลการตรวจร่างกาย</h3>
                                    <p><strong>อุณหภูมิ:</strong> ${selectedRecordDetails.vitalSigns.temperature}°C</p>
                                    <p><strong>ความดันโลหิต:</strong> ${selectedRecordDetails.vitalSigns.bloodPressure} mmHg</p>
                                    <p><strong>อัตราการเต้นของหัวใจ:</strong> ${selectedRecordDetails.vitalSigns.heartRate} bpm</p>
                                    <p><strong>อัตราการหายใจ:</strong> ${selectedRecordDetails.vitalSigns.respiratoryRate} breaths/min</p>
                                    <p><strong>ค่าออกซิเจนในเลือด:</strong> ${selectedRecordDetails.vitalSigns.oxygenSaturation}%</p>
                                    <p><strong>น้ำหนัก:</strong> ${selectedRecordDetails.vitalSigns.weight} kg</p>
                                    <p><strong>ส่วนสูง:</strong> ${selectedRecordDetails.vitalSigns.height} cm</p>
                                    <p><strong>BMI:</strong> ${selectedRecordDetails.vitalSigns.bmi}</p>
                                    <p className="md:col-span-2"><strong>ตรวจร่างกายเฉพาะระบบ:</strong> ${selectedRecordDetails.systemicExam}</p>

                                    {selectedRecordDetails.labResults.length > 0 && (
                                        <h3 className="md:col-span-2 text-xl font-bold mt-4">ผลตรวจทางห้องปฏิบัติการ</h3>
                                    )}
                                    {selectedRecordDetails.labResults.map((lab, index) => (
                                        <div key={index} className="md:col-span-2 border-b pb-2 mb-2">
                                            <p><strong>รายการตรวจ:</strong> ${lab.testName}</p>
                                            <p><strong>วันที่ตรวจ:</strong> ${lab.testDate} | <strong>ห้องแล็บ:</strong> ${lab.labName}</p>
                                            <p><strong>ผลลัพธ์:</strong> ${lab.result} | <strong>ค่าอ้างอิง:</strong> ${lab.referenceRange} | <strong>สถานะ:</strong> ${lab.status}</p>
                                        </div>
                                    ))}

                                    <h3 className="md:col-span-2 text-xl font-bold mt-4">การวินิจฉัยโรค</h3>
                                    <p className="md:col-span-2"><strong>โรคที่วินิจฉัย:</strong> ${selectedRecordDetails.diagnosis}</p>
                                    <p><strong>ลำดับโรค:</strong> ${selectedRecordDetails.diagnosisOrder}</p>
                                    <p className="md:col-span-2"><strong>คำอธิบายเพิ่มเติม:</strong> ${selectedRecordDetails.diagnosisDescription}</p>

                                    <h3 className="md:col-span-2 text-xl font-bold mt-4">แผนการรักษา</h3>
                                    <p className="md:col-span-2"><strong>ประเภทการรักษา:</strong> ${selectedRecordDetails.treatmentType.join(', ') || '-'}</p>
                                    {selectedRecordDetails.medications.length > 0 && (
                                        <h4 className="md:col-span-2 text-lg font-semibold mt-2">การจ่ายยา:</h4>
                                    )}
                                    {selectedRecordDetails.medications.map((med, index) => (
                                        <div key={index} className="md:col-span-2 border-b pb-2 mb-2">
                                            <p><strong>รายการยา:</strong> ${med.drugName}</p>
                                            <p><strong>ปริมาณ:</strong> ${med.quantity} | <strong>ความถี่:</strong> ${med.frequency} | <strong>ระยะเวลา:</strong> ${med.duration}</p>
                                            <p><strong>วิธีใช้:</strong> ${med.usageInstruction}</p>
                                        </div>
                                    ))}
                                    {selectedRecordDetails.procedures.length > 0 && (
                                        <h4 className="md:col-span-2 text-lg font-semibold mt-2">หัตถการ:</h4>
                                    )}
                                    {selectedRecordDetails.procedures.map((proc, index) => (
                                        <div key={index} className="md:col-span-2 border-b pb-2 mb-2">
                                            <p><strong>รายการหัตถการ:</strong> ${proc.procedureName}</p>
                                            <p><strong>ค่าบริการ:</strong> ${proc.serviceFee}</p>
                                        </div>
                                    ))}
                                    <p className="md:col-span-2"><strong>การให้คำแนะนำ:</strong> ${selectedRecordDetails.advice || '-'}</p>
                                    <p className="md:col-span-2"><strong>ส่งต่อ:</strong> ${selectedRecordDetails.referral || '-'}</p>
                                    <p className="md:col-span-2"><strong>ใบรับรองแพทย์/ใบลา/ใบส่งตัว:</strong> ${selectedRecordDetails.medicalCertificates || '-'}</p>
                                </div>
                                <div className="flex justify-end mt-6 gap-4">
                                    <button
                                        onClick={handleExportDetailedRecord}
                                        className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                                    >
                                        ส่งออกรายละเอียด (HTML)
                                    </button>
                                    <button
                                        onClick={handleCloseRecordDetails}
                                        className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                                    >
                                        ปิด
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showEditPatientModal && selectedPatient && (
                        <EditPatientModal
                            patient={selectedPatient}
                            onClose={handleCloseEditPatientModal}
                            onSave={handleSaveEditedPatient}
                        />
                    )}
                </div>
            );
        }

        // Treatment Record Form Component
        function TreatmentRecordForm({ recordId, onSaveSuccess, onCancelEdit }) {
            const { userRole, users } = React.useContext(AuthAndUsersContext);
            const { patients, addTreatmentRecord, updateTreatmentRecord, drugs, treatmentRecords } = React.useContext(PatientAndTreatmentContext); // Get drugs from context
            const [message, setMessage] = React.useState('');

            const initialFormData = {
                patientId: '',
                patientName: '', // For display and search
                patientIdNumber: '', // For display
                patientGender: '', // For display
                patientAgeAtVisit: '', // For display

                visitDate: new Date().toISOString().slice(0, 10), // Current date
                visitTime: new Date().toTimeString().slice(0, 5), // Current time
                visitStatus: 'รอตรวจ',
                visitType: 'ตรวจทั่วไป',
                examiningDoctor: '', // Doctor ID
                examiningDoctorName: '', // Doctor Name for display

                chiefComplaint: '',
                ccDuration: '',
                ccFactors: '',

                pastIllnessHistory: '',
                allergyHistory: '',
                preExistingConditions: '',
                medicationHistory: '',
                familyHistory: '',
                substanceUseHistory: '',

                vitalSigns: {
                    temperature: '',
                    bloodPressure: '',
                    heartRate: '',
                    respiratoryRate: '',
                    oxygenSaturation: '',
                    weight: '',
                    height: '',
                    bmi: ''
                },
                systemicExam: '',

                labResults: [], // Array of { testName, testDate, labName, result, referenceRange, status }

                diagnosis: '',
                diagnosisOrder: 'โรคหลัก',
                diagnosisDescription: '',

                treatmentType: [], // Array of selected types: การให้ยา, การทำหัตถการ, การให้คำแนะนำ, ส่งต่อ
                medications: [], // Array of { drugName, quantity, frequency, duration, usageInstruction }
                procedures: [], // Array of { procedureName, serviceFee }
                advice: '',
                referral: '',
                medicalCertificates: ''
            };

            const [formData, setFormData] = React.useState(initialFormData);

            const [patientSearchTerm, setPatientSearchTerm] = React.useState('');
            const [filteredPatients, setFilteredPatients] = React.useState([]);
            const [showPatientDropdown, setShowPatientDropdown] = React.useState(false);

            const [currentDrugInputIndex, setCurrentDrugInputIndex] = React.useState(null); // To track which drug input field is active
            const [filteredDrugs, setFilteredDrugs] = React.useState([]);
            const [showDrugDropdown, setShowDrugDropdown] = React.useState(false);

            // Filter doctors for the dropdown
            const doctors = React.useMemo(() => users.filter(user => user.role === 'แพทย์'), [users]);

            // Load record data if editing
            React.useEffect(() => {
                if (recordId) {
                    const recordToEdit = treatmentRecords.find(rec => rec.id === recordId);
                    if (recordToEdit) {
                        setFormData(recordToEdit);
                        setPatientSearchTerm(recordToEdit.patientName); // Set patient search term for display
                    }
                } else {
                    setFormData(initialFormData); // Reset form for new record
                    setPatientSearchTerm('');
                }
            }, [recordId, treatmentRecords]);


            React.useEffect(() => {
                if (patientSearchTerm) {
                    const results = patients.filter(p =>
                        p.firstNameThai.toLowerCase().includes(patientSearchTerm.toLowerCase()) ||
                        p.lastNameThai.toLowerCase().includes(patientSearchTerm.toLowerCase()) ||
                        p.idNumber.includes(patientSearchTerm)
                    );
                    setFilteredPatients(results);
                    setShowPatientDropdown(true);
                } else {
                    setFilteredPatients([]);
                    setShowPatientDropdown(false);
                }
            }, [patientSearchTerm, patients]);

            const handlePatientSelect = (patient) => {
                setFormData(prev => ({
                    ...prev,
                    patientId: patient.id,
                    patientName: `${patient.title} ${patient.firstNameThai} ${patient.lastNameThai}`,
                    // Auto-populate patient details for display in the form
                    patientIdNumber: patient.idNumber,
                    patientGender: patient.gender,
                    patientAgeAtVisit: patient.age, // Age from registration, could calculate current age if needed
                    // Also pre-fill relevant history if desired, for now just link
                    pastIllnessHistory: patient.medicalHistory,
                    allergyHistory: patient.drugAllergies,
                    preExistingConditions: patient.preExistingConditions,
                    medicationHistory: patient.regularMedications,
                    bloodType: patient.bloodType,
                    familyHistory: patient.familyMedicalHistory,
                    vaccinationHistory: patient.vaccinationHistory
                }));
                setPatientSearchTerm(`${patient.title} ${patient.firstNameThai} ${patient.lastNameThai}`);
                setShowPatientDropdown(false);
            };

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                if (name === 'treatmentType') {
                    setFormData(prev => {
                        const newTypes = checked
                            ? [...prev.treatmentType, value]
                            : prev.treatmentType.filter(type => type !== value);
                        return { ...prev, treatmentType: newTypes };
                    });
                } else if (name.startsWith('vitalSigns.')) {
                    const key = name.split('.')[1];
                    setFormData(prev => ({
                        ...prev,
                        vitalSigns: {
                            ...prev.vitalSigns,
                            [key]: value
                        }
                    }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            // Drug selection logic for medications
            const handleDrugSearchChange = (e, index) => {
                const term = e.target.value;
                setCurrentDrugInputIndex(index); // Set the active index
                // Update the drugName in the specific medication entry
                const newMedications = [...formData.medications];
                newMedications[index] = { ...newMedications[index], drugName: term };
                setFormData(prev => ({ ...prev, medications: newMedications }));

                if (term) {
                    const results = drugs.filter(drug =>
                        drug.medicalName.toLowerCase().includes(term.toLowerCase()) ||
                        drug.thaiName.toLowerCase().includes(term.toLowerCase())
                    );
                    setFilteredDrugs(results);
                    setShowDrugDropdown(true);
                } else {
                    setFilteredDrugs([]);
                    setShowDrugDropdown(false);
                }
            };

            const handleDrugSelect = (drug) => {
                if (currentDrugInputIndex !== null) {
                    const newMedications = [...formData.medications];
                    newMedications[currentDrugInputIndex] = { ...newMedications[currentDrugInputIndex], drugName: `${drug.medicalName} (${drug.thaiName})` };
                    setFormData(prev => ({ ...prev, medications: newMedications }));
                    setCurrentDrugInputIndex(null); // Clear active index
                    setFilteredDrugs([]); // Clear filtered drugs
                    setShowDrugDropdown(false);
                }
            };


            const handleAddMedication = () => {
                setFormData(prev => ({
                    ...prev,
                    medications: [...prev.medications, { drugName: '', quantity: '', frequency: '', duration: '', usageInstruction: '' }]
                }));
            };

            const handleMedicationChange = (index, e) => {
                const { name, value } = e.target;
                const newMedications = [...formData.medications];
                newMedications[index] = { ...newMedications[index], [name]: value };
                setFormData(prev => ({ ...prev, medications: newMedications }));
            };

            const handleRemoveMedication = (index) => {
                setFormData(prev => ({
                    ...prev,
                    medications: prev.medications.filter((_, i) => i !== index)
                }));
            };

            const handleAddProcedure = () => {
                setFormData(prev => ({
                    ...prev,
                    procedures: [...prev.procedures, { procedureName: '', serviceFee: '' }]
                }));
            };

            const handleProcedureChange = (index, e) => {
                const { name, value } = e.target;
                const newProcedures = [...formData.procedures];
                newProcedures[index] = { ...newProcedures[index], [name]: value };
                setFormData(prev => ({ ...prev, procedures: newProcedures }));
            };

            const handleRemoveProcedure = (index) => {
                setFormData(prev => ({
                    ...prev,
                    procedures: prev.procedures.filter((_, i) => i !== index)
                }));
            };

            const handleAddLabResult = () => {
                setFormData(prev => ({
                    ...prev,
                    labResults: [...prev.labResults, { testName: '', testDate: '', labName: '', result: '', referenceRange: '', status: 'รอผล' }]
                }));
            };

            const handleLabResultChange = (index, e) => {
                const { name, value } = e.target;
                const newLabResults = [...formData.labResults];
                newLabResults[index] = { ...newLabResults[index], [name]: value };
                setFormData(prev => ({ ...prev, labResults: newLabResults }));
            };

            const handleRemoveLabResult = (index) => {
                setFormData(prev => ({
                    ...prev,
                    labResults: prev.labResults.filter((_, i) => i !== index)
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.patientId) {
                    setMessage("กรุณาเลือกผู้ป่วย");
                    return;
                }
                if (!formData.examiningDoctor) {
                    setMessage("กรุณาเลือกแพทย์ผู้ตรวจ");
                    return;
                }

                if (recordId) {
                    updateTreatmentRecord(formData);
                    setMessage("แก้ไขบันทึกการรักษาสำเร็จ! (ข้อมูลถูกบันทึกในหน่วยความจำชั่วคราว)");
                    if (onSaveSuccess) onSaveSuccess(); // Callback to parent to close modal/navigate
                } else {
                    addTreatmentRecord(formData);
                    setMessage("บันทึกการรักษาสำเร็จ! (ข้อมูลถูกบันทึกในหน่วยความจำชั่วคราว)");
                }
                // Reset form for new entry if not editing
                if (!recordId) {
                    setFormData(initialFormData);
                    setPatientSearchTerm('');
                }
            };

            // Only Admin, Doctor, Nurse, Assistant Nurse can access this. Visitors cannot.
            if (userRole === 'ผู้เยี่ยมชม') {
                return <div className="p-8 text-red-600 font-bold text-xl">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>;
            }

            return (
                <div className="p-8 bg-gray-50 min-h-screen font-inter">
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-6">{recordId ? 'แก้ไขบันทึกการรักษาผู้ป่วย' : 'บันทึกการรักษาผู้ป่วย'}</h1>

                    <form onSubmit={handleSubmit} className="bg-white p-8 rounded-2xl shadow-2xl space-y-6">
                        {/* 1. Visit Metadata */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">1. ข้อมูลทั่วไปของการตรวจ</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">เลือกชื่อผู้ป่วย</label>
                                <input
                                    type="text"
                                    value={patientSearchTerm}
                                    onChange={(e) => setPatientSearchTerm(e.target.value)}
                                    onFocus={() => setShowPatientDropdown(true)}
                                    onBlur={() => setTimeout(() => setShowPatientDropdown(false), 100)} // Delay to allow click
                                    placeholder="พิมพ์ชื่อหรือเลขประจำตัวผู้ป่วย"
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                    required
                                    disabled={!!recordId} // Disable patient selection when editing
                                />
                                {showPatientDropdown && filteredPatients.length > 0 && (
                                    <ul className="absolute z-10 bg-white border border-gray-300 w-fit rounded-lg shadow-lg max-h-60 overflow-y-auto mt-1">
                                        {filteredPatients.map(patient => (
                                            <li
                                                key={patient.id}
                                                onMouseDown={() => handlePatientSelect(patient)} // Use onMouseDown to prevent blur
                                                className="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-800"
                                            >
                                                {patient.title} {patient.firstNameThai} {patient.lastNameThai} ({patient.idNumber})
                                            </li>
                                        ))}
                                    </ul>
                                )}
                                {formData.patientId && (
                                    <p className="text-sm text-gray-500 mt-1">ผู้ป่วยที่เลือก: {formData.patientName}</p>
                                )}
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">แพทย์ผู้ตรวจ</label>
                                <select
                                    name="examiningDoctor"
                                    value={formData.examiningDoctor}
                                    onChange={(e) => {
                                        const selectedDoctor = doctors.find(doc => doc.id === e.target.value);
                                        setFormData(prev => ({
                                            ...prev,
                                            examiningDoctor: e.target.value,
                                            examiningDoctorName: selectedDoctor ? selectedDoctor.fullName : ''
                                        }));
                                    }}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                    required
                                >
                                    <option value="">เลือกแพทย์</option>
                                    {doctors.map(doctor => (
                                        <option key={doctor.id} value={doctor.id}>{doctor.fullName}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">วันที่และเวลาตรวจ</label>
                                <input type="date" name="visitDate" value={formData.visitDate} onChange={handleChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                <input type="time" name="visitTime" value={formData.visitTime} onChange={handleChange} required
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 mt-2"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">สถานะการเข้ารับบริการ</label>
                                <select name="visitStatus" value={formData.visitStatus} onChange={handleChange} required
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="รอตรวจ">รอตรวจ</option>
                                    <option value="ตรวจเสร็จ">ตรวจเสร็จ</option>
                                    <option value="ยกเลิก">ยกเลิก</option>
                                </select>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">ประเภทการตรวจ</label>
                                <select name="visitType" value={formData.visitType} onChange={handleChange} required
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="ตรวจทั่วไป">ตรวจทั่วไป</option>
                                    <option value="ตรวจตามนัด">ตรวจตามนัด</option>
                                    <option value="ตรวจเร่งด่วน / ฉุกเฉิน">ตรวจเร่งด่วน / ฉุกเฉิน</option>
                                    <option value="ติดตามอาการ">ติดตามอาการ</option>
                                    <option value="ฉีดวัคซีน / เจาะเลือด">ฉีดวัคซีน / เจาะเลือด</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </select>
                            </div>
                        </div>

                        {/* 2. Patient Data (Display only) */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">2. ข้อมูลผู้ป่วย</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                            <p><strong>ชื่อ-นามสกุล:</strong> {formData.patientName || '-'}</p>
                            <p><strong>เลขผู้ป่วย:</strong> {formData.patientIdNumber || '-'}</p>
                            <p><strong>เพศ:</strong> {formData.patientGender || '-'}</p>
                            <p><strong>อายุ ณ วันที่ตรวจ:</strong> {formData.patientAgeAtVisit || '-'} ปี</p>
                        </div>

                        {/* 3. Chief Complaint */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">3. อาการเบื้องต้น (Chief Complaint - CC)</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">รายละเอียดอาการที่ผู้ป่วยแจ้ง</label>
                                <textarea name="chiefComplaint" value={formData.chiefComplaint} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ระยะเวลาที่มีอาการ</label>
                                <input type="text" name="ccDuration" value={formData.ccDuration} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ปัจจัยกระตุ้น / บรรเทา</label>
                                <input type="text" name="ccFactors" value={formData.ccFactors} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                        </div>

                        {/* 4. Related Medical History */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">4. ประวัติทางการแพทย์ที่เกี่ยวข้อง (History)</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ประวัติการเจ็บป่วยครั้งก่อน (เกี่ยวข้องกับอาการปัจจุบัน)</label>
                                <textarea name="pastIllnessHistory" value={formData.pastIllnessHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ประวัติแพ้ยา / แพ้อาหาร</label>
                                <textarea name="allergyHistory" value={formData.allergyHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">โรคประจำตัว</label>
                                <textarea name="preExistingConditions" value={formData.preExistingConditions} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ประวัติการใช้ยา</label>
                                <textarea name="medicationHistory" value={formData.medicationHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ประวัติครอบครัว (โรคทางพันธุกรรม ฯลฯ)</label>
                                <textarea name="familyHistory" value={formData.familyHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ประวัติการใช้สารเสพติด / แอลกอฮอล์ / บุหรี่</label>
                                <textarea name="substanceUseHistory" value={formData.substanceUseHistory} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>

                        {/* 5. Physical Examination */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">5. ผลการตรวจร่างกาย (Physical Examination)</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">อุณหภูมิ (°C)</label>
                                <input type="text" name="vitalSigns.temperature" value={formData.vitalSigns.temperature} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ความดันโลหิต (mmHg)</label>
                                <input type="text" name="vitalSigns.bloodPressure" value={formData.vitalSigns.bloodPressure} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">อัตราการเต้นของหัวใจ (bpm)</label>
                                <input type="text" name="vitalSigns.heartRate" value={formData.vitalSigns.heartRate} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">อัตราการหายใจ (breaths/min)</label>
                                <input type="text" name="vitalSigns.respiratoryRate" value={formData.vitalSigns.respiratoryRate} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ค่าออกซิเจนในเลือด (%)</label>
                                <input type="text" name="vitalSigns.oxygenSaturation" value={formData.vitalSigns.oxygenSaturation} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">น้ำหนัก (kg)</label>
                                <input type="text" name="vitalSigns.weight" value={formData.vitalSigns.weight} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ส่วนสูง (cm)</label>
                                <input type="text" name="vitalSigns.height" value={formData.vitalSigns.height} onChange={handleChange}
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ดัชนีมวลกาย (BMI)</label>
                                <input type="text" name="vitalSigns.bmi" value={formData.vitalSigns.bmi} onChange={handleChange} readOnly disabled
                                       className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"/>
                            </div>
                            <div className="md:col-span-3">
                                <label className="block text-sm font-medium text-gray-700">ตรวจร่างกายเฉพาะระบบ (ระบบทางเดินหายใจ, หัวใจ, ผิวหนัง, ช่องปาก ฯลG)</label>
                                <textarea name="systemicExam" value={formData.systemicExam} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>

                        {/* 6. Lab / Imaging Results */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">6. ผลตรวจทางห้องปฏิบัติการ (Lab / Imaging Results)</h2>
                        {formData.labResults.map((lab, index) => (
                            <div key={index} className="grid grid-cols-1 md:grid-cols-3 gap-4 border border-gray-200 p-4 rounded-lg relative mb-4">
                                <button type="button" onClick={() => handleRemoveLabResult(index)} className="absolute top-2 right-2 text-red-500 hover:text-red-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">รายการตรวจ</label>
                                    <input type="text" name="testName" value={lab.testName} onChange={(e) => handleLabResultChange(index, e)}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">วันที่ตรวจ</label>
                                    <input type="date" name="testDate" value={lab.testDate} onChange={(e) => handleLabResultChange(index, e)}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ห้องแล็บที่ทำ</label>
                                    <input type="text" name="labName" value={lab.labName} onChange={(e) => handleLabResultChange(index, e)}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ค่าผลลัพธ์</label>
                                    <input type="text" name="result" value={lab.result} onChange={(e) => handleLabResultChange(index, e)}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ค่าอ้างอิง</label>
                                    <input type="text" name="referenceRange" value={lab.referenceRange} onChange={(e) => handleLabResultChange(index, e)}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">สถานะผลตรวจ</label>
                                    <select name="status" value={lab.status} onChange={(e) => handleLabResultChange(index, e)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                                        <option value="รอผล">รอผล</option>
                                        <option value="ได้ผลแล้ว">ได้ผลแล้ว</option>
                                        <option value="ส่งต่อ">ส่งต่อ</option>
                                    </select>
                                </div>
                            </div>
                        ))}
                        <button type="button" onClick={handleAddLabResult}
                                className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-md transition duration-300">
                            + เพิ่มผลตรวจห้องปฏิบัติการ
                        </button>

                        {/* 7. Diagnosis */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">7. การวินิจฉัยโรค (Diagnosis)</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">โรคที่วินิจฉัย</label>
                                <textarea name="diagnosis" value={formData.diagnosis} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ลำดับโรค</label>
                                <select name="diagnosisOrder" value={formData.diagnosisOrder} onChange={handleChange}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="โรคหลัก">โรคหลัก</option>
                                    <option value="โรครอง">โรครอง</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">คำอธิบายเพิ่มเติม (เช่น ระยะของโรค, ความรุนแรง)</label>
                                <textarea name="diagnosisDescription" value={formData.diagnosisDescription} onChange={handleChange} rows="3"
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>

                        {/* 8. Treatment Plan */}
                        <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 mt-8">8. แผนการรักษา (Plan / Treatment Plan)</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ประเภทการรักษา</label>
                                <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {['การให้ยา', 'การทำหัตถการ', 'การให้คำแนะนำ', 'ส่งต่อ'].map(type => (
                                        <label key={type} className="inline-flex items-center">
                                            <input
                                                type="checkbox"
                                                name="treatmentType"
                                                value={type}
                                                checked={formData.treatmentType.includes(type)}
                                                onChange={handleChange}
                                                className="form-checkbox h-5 w-5 text-blue-600 rounded"
                                            />
                                            <span className="ml-2 text-gray-700">{type}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* Medications */}
                            <h3 className="text-xl font-bold text-gray-800 mt-6 mb-2">การจ่ายยา</h3>
                            {formData.medications.map((med, index) => (
                                <div key={index} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 border border-gray-200 p-4 rounded-lg relative mb-4">
                                    <button type="button" onClick={() => handleRemoveMedication(index)} className="absolute top-2 right-2 text-red-500 hover:text-red-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">รายการยา</label>
                                        <input
                                            type="text"
                                            name="drugName"
                                            value={med.drugName}
                                            onChange={(e) => handleDrugSearchChange(e, index)}
                                            onFocus={() => { setCurrentDrugInputIndex(index); setShowDrugDropdown(true); }}
                                            onBlur={() => setTimeout(() => setShowDrugDropdown(false), 100)}
                                            placeholder="พิมพ์เพื่อค้นหายา"
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"
                                        />
                                        {showDrugDropdown && currentDrugInputIndex === index && filteredDrugs.length > 0 && (
                                            <ul className="absolute z-10 bg-white border border-gray-300 w-fit rounded-lg shadow-lg max-h-60 overflow-y-auto mt-1">
                                                {filteredDrugs.map(drug => (
                                                    <li
                                                        key={drug.id}
                                                        onMouseDown={() => handleDrugSelect(drug)}
                                                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-800"
                                                    >
                                                        {drug.medicalName} ({drug.thaiName})
                                                    </li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">ปริมาณ</label>
                                        <input type="text" name="quantity" value={med.quantity} onChange={(e) => handleMedicationChange(index, e)}
                                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">ความถี่</label>
                                        <input type="text" name="frequency" value={med.frequency} onChange={(e) => handleMedicationChange(index, e)}
                                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">ระยะเวลา</label>
                                        <input type="text" name="duration" value={med.duration} onChange={(e) => handleMedicationChange(index, e)}
                                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700">วิธีใช้ (ก่อน/หลังอาหาร, เช้า/เย็น ฯลฯ)</label>
                                        <input type="text" name="usageInstruction" value={med.usageInstruction} onChange={(e) => handleMedicationChange(index, e)}
                                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                    </div>
                                </div>
                            ))}
                            <button type="button" onClick={handleAddMedication}
                                    className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-md transition duration-300">
                                + เพิ่มรายการยา
                            </button>

                            {/* Procedures */}
                            <h3 className="text-xl font-bold text-gray-800 mt-6 mb-2">หัตถการ</h3>
                            {formData.procedures.map((proc, index) => (
                                <div key={index} className="grid grid-cols-1 md:grid-cols-2 gap-4 border border-gray-200 p-4 rounded-lg relative mb-4">
                                    <button type="button" onClick={() => handleRemoveProcedure(index)} className="absolute top-2 right-2 text-red-500 hover:text-red-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">รายการหัตถการ</label>
                                        <input type="text" name="procedureName" value={proc.procedureName} onChange={(e) => handleProcedureChange(index, e)}
                                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">ค่าบริการ</label>
                                        <input type="text" name="serviceFee" value={proc.serviceFee} onChange={(e) => handleProcedureChange(index, e)}
                                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"/>
                                    </div>
                                </div>
                            ))}
                            <button type="button" onClick={handleAddProcedure}
                                    className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-md transition duration-300">
                                + เพิ่มรายการหัตถการ
                            </button>

                            {/* Other treatment plans */}
                            <div className="space-y-4 mt-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">การให้คำแนะนำ</label>
                                    <textarea name="advice" value={formData.advice} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ส่งต่อ (ไป รพ. อื่น / เฉพาะทาง)</label>
                                    <textarea name="referral" value={formData.referral} onChange={handleChange} rows="3"
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">ใบรับรองแพทย์ / ใบลา / ใบส่งตัว (ถ้ามีแนบ)</label>
                                    <input type="text" name="medicalCertificates" value={formData.medicalCertificates} onChange={handleChange}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end gap-4 mt-6">
                            {recordId && (
                                <button type="button" onClick={onCancelEdit}
                                        className="py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-lg font-semibold text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                                    ยกเลิก
                                </button>
                            )}
                            <button type="submit"
                                    className="py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                {recordId ? 'บันทึกการแก้ไข' : 'บันทึกการรักษา'}
                            </button>
                        </div>
                    </form>
                    <MessageBox message={message} onClose={() => setMessage('')} />
                </div>
            );
        }

        // Drug Inventory Component
        function DrugInventory() {
            const { userRole } = React.useContext(AuthAndUsersContext);
            const { drugs, addDrug } = React.useContext(PatientAndTreatmentContext);
            const [newDrugMedicalName, setNewDrugMedicalName] = React.useState('');
            const [newDrugThaiName, setNewDrugThaiName] = React.useState('');
            const [message, setMessage] = React.useState('');

            const handleAddDrug = (e) => {
                e.preventDefault();
                if (newDrugMedicalName.trim() === '' || newDrugThaiName.trim() === '') {
                    setMessage('กรุณากรอกชื่อยา (ทางการแพทย์) และชื่อยา (ไทย)');
                    return;
                }
                addDrug({ medicalName: newDrugMedicalName.trim(), thaiName: newDrugThaiName.trim() });
                setMessage(`เพิ่มยา "${newDrugThaiName}" สำเร็จ!`);
                setNewDrugMedicalName('');
                setNewDrugThaiName('');
            };

            if (userRole === 'ผู้เยี่ยมชม') {
                return <div className="p-8 text-red-600 font-bold text-xl">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>;
            }

            return (
                <div className="p-8 bg-gray-50 min-h-screen font-inter">
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-6">คลังยา</h1>

                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">เพิ่มยาใหม่</h2>
                        <form onSubmit={handleAddDrug} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ชื่อยา (ทางการแพทย์)</label>
                                <input
                                    type="text"
                                    value={newDrugMedicalName}
                                    onChange={(e) => setNewDrugMedicalName(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ชื่อยา (ไทย)</label>
                                <input
                                    type="text"
                                    value={newDrugThaiName}
                                    onChange={(e) => setNewDrugThaiName(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300"
                            >
                                เพิ่มยา
                            </button>
                        </form>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">รายการยาในคลัง ({drugs.length} รายการ)</h2>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อยา (ทางการแพทย์)</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อยา (ไทย)</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {drugs.map((drug) => (
                                        <tr key={drug.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{drug.medicalName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{drug.thaiName}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <MessageBox message={message} onClose={() => setMessage('')} />
                </div>
            );
        }


        // Main App Component
        function App() {
            const [currentPage, setCurrentPage] = React.useState('login'); // 'login', 'dashboard', 'admin', 'patient-registration', 'patient-search-and-records', 'treatment-record-form', 'drug-inventory'
            const [editingRecordId, setEditingRecordId] = React.useState(null); // State to hold ID of record being edited

            const { userRole, loadingAuth } = React.useContext(AuthAndUsersContext);

            React.useEffect(() => {
                if (!loadingAuth && userRole) {
                    setCurrentPage('dashboard'); // Redirect to dashboard after successful login or auth check
                }
            }, [userRole, loadingAuth]);

            const handleLoginSuccess = (role) => {
                setCurrentPage('dashboard');
            };

            const handleLogout = () => {
                setCurrentPage('login');
            };

            const handleEditTreatmentRecord = (recordId) => {
                setEditingRecordId(recordId);
                setCurrentPage('treatment-record-form');
            };

            const handleTreatmentRecordSaveSuccess = () => {
                setEditingRecordId(null); // Clear editing state
                setCurrentPage('patient-search-and-records'); // Go back to patient search to see updated records
            };

            const handleCancelEditTreatmentRecord = () => {
                setEditingRecordId(null); // Clear editing state
                setCurrentPage('patient-search-and-records'); // Go back to patient search
            };

            const renderPage = () => {
                switch (currentPage) {
                    case 'login':
                        return <Login onLoginSuccess={handleLoginSuccess} />;
                    case 'dashboard':
                        return <Dashboard />;
                    case 'admin':
                        return <AdminPanel />;
                    case 'patient-registration':
                        return <PatientRegistration />;
                    case 'patient-search-and-records':
                        return <PatientSearchAndRecords onEditTreatmentRecord={handleEditTreatmentRecord} />;
                    case 'treatment-record-form':
                        return <TreatmentRecordForm
                                    recordId={editingRecordId}
                                    onSaveSuccess={handleTreatmentRecordSaveSuccess}
                                    onCancelEdit={handleCancelEditTreatmentRecord}
                                />;
                    case 'drug-inventory':
                        return <DrugInventory />;
                    default:
                        return <Login onLoginSuccess={handleLoginSuccess} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 font-inter">
                    {currentPage !== 'login' && (
                        <nav className="bg-blue-700 p-4 shadow-lg">
                            <div className="container mx-auto flex justify-between items-center">
                                <div className="text-white text-2xl font-bold">คลินิกเวชกรรม</div>
                                <div className="flex space-x-4">
                                    <button onClick={() => setCurrentPage('dashboard')} className="text-white hover:text-blue-200 px-3 py-2 rounded-lg transition duration-300">แดชบอร์ด</button>
                                    {(userRole === 'Admin' || userRole === 'แพทย์' || userRole === 'พยาบาล' || userRole === 'ผู้ช่วยพยาบาล') && (
                                        <>
                                            <button onClick={() => setCurrentPage('patient-registration')} className="text-white hover:text-blue-200 px-3 py-2 rounded-lg transition duration-300">ลงทะเบียนผู้ป่วยใหม่</button>
                                            <button onClick={() => setCurrentPage('patient-search-and-records')} className="text-white hover:text-blue-200 px-3 py-2 rounded-lg transition duration-300">ค้นหาผู้ป่วยและบันทึกการรักษา</button>
                                            <button onClick={() => { setEditingRecordId(null); setCurrentPage('treatment-record-form'); }} className="text-white hover:text-blue-200 px-3 py-2 rounded-lg transition duration-300">บันทึกการรักษาผู้ป่วย</button>
                                            <button onClick={() => setCurrentPage('drug-inventory')} className="text-white hover:text-blue-200 px-3 py-2 rounded-lg transition duration-300">คลังยา</button>
                                        </>
                                    )}
                                    {userRole === 'Admin' && (
                                        <button onClick={() => setCurrentPage('admin')} className="text-white hover:text-blue-200 px-3 py-2 rounded-lg transition duration-300">จัดการผู้ใช้</button>
                                    )}
                                    <button onClick={handleLogout} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-300">ออกจากระบบ</button>
                                </div>
                            </div>
                        </nav>
                    )}
                    {renderPage()}
                </div>
            );
        }

        // Wrap the App with AuthAndUsersProvider and PatientAndTreatmentProvider
        function WrappedApp() {
            return (
                <AuthAndUsersProvider>
                    <PatientAndTreatmentProvider>
                        <App />
                    </PatientAndTreatmentProvider>
                </AuthAndUsersProvider>
            );
        }

        // Mount the React application
        const domNode = document.getElementById('root');
        const root = ReactDOM.createRoot(domNode);
        root.render(<WrappedApp />);
    </script>
</body>
</html>
